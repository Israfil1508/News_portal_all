<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü - ‡¶®‡¶ø‡¶â‡¶ú ‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶æ‡¶≤</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="logo">üì∞ ‡¶®‡¶ø‡¶â‡¶ú ‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶æ‡¶≤</div>
            <nav class="admin-menu">
                <a href="dashboard.html">üìä ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</a>
                <a href="articles.html" class="active">üìù ‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤</a>
                <a href="categories.html">üìÅ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</a>
                <a href="users.html" id="usersLink">üë• ‡¶á‡¶â‡¶ú‡¶æ‡¶∞</a>
                <a href="../index.html">üè† ‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú</a>
                <a href="#" onclick="logout()">üö™ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <div class="admin-header">
                <h1>‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h1>
                <a href="article-form.html" class="btn btn-primary">+ ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤</a>
            </div>

            <div id="alertContainer"></div>

            <!-- Search & Filter -->
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                <input type="text" id="searchInput" class="form-control" placeholder="‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." style="max-width: 250px;">
                <select id="categoryFilter" class="form-control" style="max-width: 180px;">
                    <option value="">‡¶∏‡¶¨ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</option>
                </select>
                <select id="statusFilter" class="form-control" style="max-width: 150px;">
                    <option value="">‡¶∏‡¶¨ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</option>
                    <option value="published">‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂‡¶ø‡¶§</option>
                    <option value="pending">‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®‡ßá‡¶∞ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ‡ßü</option>
                    <option value="draft">‡¶°‡ßç‡¶∞‡¶æ‡¶´‡ßç‡¶ü</option>
                    <option value="archived">‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠‡¶°</option>
                </select>
                <button class="btn btn-primary" onclick="loadArticles()">‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
            </div>

            <!-- Articles Table -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ</th>
                            <th>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</th>
                            <th>‡¶≤‡ßá‡¶ñ‡¶ï</th>
                            <th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th>
                            <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th>
                            <th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                        </tr>
                    </thead>
                    <tbody id="articlesTable">
                        <tr><td colspan="6" class="text-center">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination"></div>
        </main>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <p>‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶è‡¶á ‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?</p>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-secondary" onclick="closeModal()">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <button class="btn btn-danger" id="confirmDelete">‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let deleteId = null;

        document.addEventListener('DOMContentLoaded', () => {
            if (!requireAdmin()) return;
            
            // Hide users link for editors
            const user = getCurrentUser();
            if (user.role === 'editor') {
                const usersLink = document.getElementById('usersLink');
                if (usersLink) usersLink.style.display = 'none';
            }
            
            loadCategoryFilter();
            loadArticles();
        });

        async function loadCategoryFilter() {
            try {
                const response = await CategoriesAPI.getAll();
                const categories = response.data || response;
                const select = document.getElementById('categoryFilter');
                
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        async function loadArticles(page = 1) {
            const tbody = document.getElementById('articlesTable');
            const search = document.getElementById('searchInput').value;
            const category = document.getElementById('categoryFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</td></tr>';
            
            try {
                let params = `?page=${page}&limit=10`;
                if (search) params += `&search=${encodeURIComponent(search)}`;
                if (category) params += `&category=${category}`;
                if (status) params += `&status=${status}`;
                
                const response = await ArticlesAPI.getAll(params);
                const articles = response.data || response;
                totalPages = response.totalPages || 1;
                currentPage = page;
                
                if (articles.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">‡¶ï‡ßã‡¶® ‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</td></tr>';
                    document.getElementById('pagination').innerHTML = '';
                    return;
                }
                
                const currentUser = getCurrentUser();
                const isAdminUser = currentUser.role === 'admin';
                
                tbody.innerHTML = articles.map(article => {
                    let statusBadge = '';
                    switch(article.status) {
                        case 'published':
                            statusBadge = '<span class="badge badge-success">‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂‡¶ø‡¶§</span>';
                            break;
                        case 'pending':
                            statusBadge = '<span class="badge badge-warning">‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®‡ßá‡¶∞ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ‡¶Ø‡¶º</span>';
                            break;
                        case 'archived':
                            statusBadge = '<span class="badge badge-secondary">‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠‡¶°</span>';
                            break;
                        default:
                            statusBadge = '<span class="badge badge-secondary">‡¶°‡ßç‡¶∞‡¶æ‡¶´‡¶ü</span>';
                    }
                    
                    let actions = `<a href="article-form.html?id=${article.id}" class="btn btn-sm btn-outline">‚úèÔ∏è ‡¶è‡¶°‡¶ø‡¶ü</a>`;
                    
                    // Only admin can approve pending articles
                    if (isAdminUser && article.status === 'pending') {
                        actions += ` <button class="btn btn-sm btn-success" onclick="approveArticle(${article.id})">‚úÖ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®</button>`;
                    }
                    
                    // Only admin can delete
                    if (isAdminUser) {
                        actions += ` <button class="btn btn-sm btn-danger" onclick="confirmDelete(${article.id})">üóëÔ∏è ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>`;
                    }
                    
                    return `
                    <tr>
                        <td><a href="../article.html?id=${article.id}" target="_blank">${truncateText(article.title, 35)}</a></td>
                        <td>${article.category?.name || '-'}</td>
                        <td>${article.author?.firstName || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>${formatDate(article.createdAt)}</td>
                        <td class="actions">${actions}</td>
                    </tr>
                `}).join('');
                
                renderPagination();
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</td></tr>';
                console.error('Error loading articles:', error);
            }
        }

        function renderPagination() {
            const container = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            if (currentPage > 1) {
                html += `<a href="#" onclick="loadArticles(${currentPage - 1}); return false;">¬´ ‡¶Ü‡¶ó‡ßá‡¶∞</a>`;
            }
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    html += `<span class="active">${i}</span>`;
                } else {
                    html += `<a href="#" onclick="loadArticles(${i}); return false;">${i}</a>`;
                }
            }
            
            if (currentPage < totalPages) {
                html += `<a href="#" onclick="loadArticles(${currentPage + 1}); return false;">‡¶™‡¶∞‡ßá‡¶∞ ¬ª</a>`;
            }
            
            container.innerHTML = html;
        }

        function confirmDelete(id) {
            deleteId = id;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deleteId = null;
        }

        document.getElementById('confirmDelete').addEventListener('click', async () => {
            if (!deleteId) return;
            
            try {
                await ArticlesAPI.delete(deleteId);
                closeModal();
                document.getElementById('alertContainer').innerHTML = '<div class="alert alert-success">‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</div>';
                loadArticles(currentPage);
            } catch (error) {
                document.getElementById('alertContainer').innerHTML = `<div class="alert alert-error">${error.message || '‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá'}</div>`;
            }
        });        
        async function approveArticle(id) {
            try {
                await ArticlesAPI.update(id, { status: 'published' });
                document.getElementById('alertContainer').innerHTML = '<div class="alert alert-success">‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ì ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá</div>';
                loadArticles(currentPage);
            } catch (error) {
                document.getElementById('alertContainer').innerHTML = `<div class="alert alert-error">${error.message || '‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá'}</div>`;
            }
        }    </script>
</body>
</html>
