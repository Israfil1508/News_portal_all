<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤ ‡¶´‡¶∞‡ßç‡¶Æ - ‡¶®‡¶ø‡¶â‡¶ú ‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶æ‡¶≤</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="logo">üì∞ ‡¶®‡¶ø‡¶â‡¶ú ‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶æ‡¶≤</div>
            <nav class="admin-menu">
                <a href="dashboard.html">üìä ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</a>
                <a href="articles.html" class="active">üìù ‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤</a>
                <a href="categories.html">üìÅ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</a>
                <a href="users.html" id="usersLink">üë• ‡¶á‡¶â‡¶ú‡¶æ‡¶∞</a>
                <a href="../index.html">üè† ‡¶π‡ßã‡¶Æ‡¶™‡ßá‡¶ú</a>
                <a href="#" onclick="logout()">üö™ ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <div class="admin-header">
                <h1 id="pageTitle">‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤</h1>
                <a href="articles.html" class="btn btn-outline">‚Üê ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</a>
            </div>

            <div id="alertContainer"></div>

            <div class="table-container" style="padding: 30px;">
                <form id="articleForm" onsubmit="handleSubmit(event)">
                    <div class="form-group">
                        <label for="title">‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ *</label>
                        <input type="text" id="title" class="form-control" placeholder="‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤‡ßá‡¶∞ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ" required>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label for="category">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø *</label>
                            <select id="category" class="form-control" required>
                                <option value="">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="status">‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</label>
                            <select id="status" class="form-control">
                                <option value="draft">‡¶°‡ßç‡¶∞‡¶æ‡¶´‡¶ü</option>
                                <option value="pending">‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</option>
                                <!-- Admin-only options added via JS -->
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="image">‡¶õ‡¶¨‡¶ø‡¶∞ URL</label>
                        <input type="url" id="image" class="form-control" placeholder="https://example.com/image.jpg">
                    </div>

                    <div class="form-group">
                        <label for="content">‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü *</label>
                        <textarea id="content" class="form-control" rows="15" placeholder="‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§..." required></textarea>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        <a href="articles.html" class="btn btn-secondary btn-lg">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</a>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        let editId = null;

        document.addEventListener('DOMContentLoaded', () => {
            if (!requireAdmin()) return;
            
            // Hide users link for editors
            const user = getCurrentUser();
            if (user.role === 'editor') {
                const usersLink = document.getElementById('usersLink');
                if (usersLink) usersLink.style.display = 'none';
            }
            
            // Add admin-only status options
            if (user.role === 'admin') {
                const statusSelect = document.getElementById('status');
                // Change pending text for admin
                statusSelect.querySelector('option[value="pending"]').textContent = '‡¶Ö‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶®‡ßá‡¶∞ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ‡¶Ø‡¶º';
                // Add published option
                const publishedOption = document.createElement('option');
                publishedOption.value = 'published';
                publishedOption.textContent = '‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∂‡¶ø‡¶§';
                statusSelect.appendChild(publishedOption);
                // Add archived option
                const archivedOption = document.createElement('option');
                archivedOption.value = 'archived';
                archivedOption.textContent = '‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠‡¶°';
                statusSelect.appendChild(archivedOption);
            }
            
            loadCategories();
            
            // Check if editing
            const urlParams = new URLSearchParams(window.location.search);
            editId = urlParams.get('id');
            
            if (editId) {
                document.getElementById('pageTitle').textContent = '‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤ ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®';
                loadArticle(editId);
            }
        });

        async function loadCategories() {
            try {
                const response = await CategoriesAPI.getAll();
                const categories = response.data || response;
                const select = document.getElementById('category');
                
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        async function loadArticle(id) {
            try {
                const response = await ArticlesAPI.getOne(id);
                const article = response.data || response;
                
                document.getElementById('title').value = article.title;
                document.getElementById('category').value = article.categoryId;
                document.getElementById('status').value = article.status;
                document.getElementById('image').value = article.imageUrl || '';
                document.getElementById('content').value = article.content;
            } catch (error) {
                document.getElementById('alertContainer').innerHTML = '<div class="alert alert-error">‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</div>';
                console.error('Error loading article:', error);
            }
        }

        async function handleSubmit(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const alertContainer = document.getElementById('alertContainer');
            
            const data = {
                title: document.getElementById('title').value,
                categoryId: parseInt(document.getElementById('category').value),
                status: document.getElementById('status').value,
                imageUrl: document.getElementById('image').value || null,
                content: document.getElementById('content').value,
            };
            
            alertContainer.innerHTML = '';
            submitBtn.textContent = '‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...';
            submitBtn.disabled = true;
            
            try {
                if (editId) {
                    await ArticlesAPI.update(editId, data);
                    alertContainer.innerHTML = '<div class="alert alert-success">‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶∏‡¶´‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</div>';
                } else {
                    await ArticlesAPI.create(data);
                    alertContainer.innerHTML = '<div class="alert alert-success">‡¶Ü‡¶∞‡ßç‡¶ü‡¶ø‡¶ï‡ßá‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶∏‡¶´‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</div>';
                    
                    // Clear form
                    document.getElementById('articleForm').reset();
                }
            } catch (error) {
                alertContainer.innerHTML = `<div class="alert alert-error">${error.message || '‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá'}</div>`;
            } finally {
                submitBtn.textContent = '‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®';
                submitBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
